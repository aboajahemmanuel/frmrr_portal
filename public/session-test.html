<!DOCTYPE html>
<html>
<head>
    <title>Session Timeout Test</title>
    <meta name="session-timeout-minutes" content="2">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>Session Timeout Test</h1>
        <p>This page tests the session timeout functionality with a 2-minute timeout.</p>
        <p>Warning should appear after 96 seconds (80% of 2 minutes).</p>
        <p>Redirect should happen after 120 seconds (2 minutes).</p>
        <button id="reset-timers" class="btn btn-primary">Reset Timers</button>
        <button id="show-warning" class="btn btn-warning">Show Warning</button>
        <div id="status" class="mt-3 p-2 bg-info text-white">Session is active</div>
    </div>

    <script>
        $(document).ready(function() {
            console.log('Test page loaded');
            
            // Get session timeout from meta tag
            var timeoutMinutes = 2; // default
            var metaTag = document.head.querySelector('meta[name="session-timeout-minutes"]');
            console.log('Meta tag found:', metaTag);
            
            if (metaTag && metaTag.content) {
                timeoutMinutes = parseInt(metaTag.content) || 2;
                console.log('Using timeout from meta tag:', timeoutMinutes);
            }
            
            var warnAfter = (timeoutMinutes * 60 * 1000) * 0.8; // Warn at 80% of timeout
            var redirAfter = timeoutMinutes * 60 * 1000; // Full timeout
            
            console.log('Timeout minutes:', timeoutMinutes);
            console.log('Warn after (ms):', warnAfter);
            console.log('Redirect after (ms):', redirAfter);
            
            // Create the dialog HTML
            var countdown = Math.floor((redirAfter - warnAfter) / 1000);
            var countdownDisplay = '<div id="session-timeout-dialog" class="modal fade" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="sessionTimeoutModalLabel" aria-hidden="true" style="display: none;">' +
                '<div class="modal-dialog">' +
                '<div class="modal-content">' +
                '<div class="modal-header">' +
                '<h4 class="modal-title">Your session is about to expire!</h4>' +
                '<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>' +
                '</div>' +
                '<div class="modal-body">' +
                '<p id="countdown-message">Redirecting in <span id="countdown-display">' + countdown + '</span> seconds.</p>' +
                '<div class="progress mb-3"><div class="progress-bar bg-warning" id="countdown-bar" role="progressbar" style="width: 100%;"></div></div>' +
                '</div>' +
                '<div class="modal-footer">' +
                '<button id="session-timeout-keepalive" type="button" class="btn btn-primary" data-bs-dismiss="modal">Stay Connected</button>' +
                '<a href="/login" class="btn btn-danger">Logout</a>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</div>';
            
            // Add the dialog to the page
            $('body').append(countdownDisplay);
            console.log('Dialog appended to body');
            
            var warningTimer, redirectTimer;
            
            // Function to reset timers
            var resetTimers = function() {
                console.log('Resetting timers');
                clearTimeout(warningTimer);
                clearTimeout(redirectTimer);
                
                // Update status
                $('#status').removeClass('bg-warning bg-danger').addClass('bg-info').text('Session is active');
                
                warningTimer = setTimeout(showWarning, warnAfter);
                redirectTimer = setTimeout(redirect, redirAfter);
                console.log('New timers set - warnAfter:', warnAfter, 'redirAfter:', redirAfter);
            };
            
            // Function to show warning
            var showWarning = function() {
                console.log('Showing session timeout warning');
                
                // Update status
                $('#status').removeClass('bg-info').addClass('bg-warning').text('Warning: Session will expire soon!');
                
                // Show the warning dialog
                if ($('#session-timeout-dialog').length > 0) {
                    console.log('Dialog exists, showing it');
                    
                    // Try multiple methods to show the modal
                    try {
                        // Method 1: Bootstrap 5
                        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                            var modalElement = document.getElementById('session-timeout-dialog');
                            var modal = bootstrap.Modal.getInstance(modalElement);
                            if (!modal) {
                                modal = new bootstrap.Modal(modalElement, {
                                    backdrop: 'static',
                                    keyboard: false
                                });
                            }
                            modal.show();
                            console.log('Bootstrap 5 modal shown');
                        } 
                        // Method 2: Bootstrap 4/jQuery
                        else if ($.fn.modal) {
                            $('#session-timeout-dialog').modal('show');
                            console.log('Bootstrap 4/jQuery modal shown');
                        } 
                        // Method 3: Fallback
                        else {
                            $('#session-timeout-dialog').show();
                            console.log('Fallback modal shown');
                        }
                    } catch (e) {
                        console.error('Error showing modal:', e);
                        // Final fallback
                        $('#session-timeout-dialog').show();
                    }
                    
                    // Start the countdown
                    var countdownValue = Math.floor((redirAfter - warnAfter) / 1000);
                    $('#countdown-display').text(countdownValue);
                    
                    var startTime = new Date().getTime();
                    var endTime = startTime + (redirAfter - warnAfter);
                    
                    var updateCountdown = function() {
                        var now = new Date().getTime();
                        var remaining = Math.floor((endTime - now) / 1000);
                        
                        if (remaining >= 0) {
                            $('#countdown-display').text(remaining);
                            var percentage = (remaining / countdownValue) * 100;
                            $('#countdown-bar').css('width', percentage + '%');
                            
                            // Update status
                            $('#status').removeClass('bg-info bg-warning').addClass('bg-danger').text('Session expires in ' + remaining + ' seconds!');
                            
                            setTimeout(updateCountdown, 1000);
                        }
                    };
                    
                    updateCountdown();
                } else {
                    console.log('Dialog does not exist!');
                }
            };
            
            // Function to redirect
            var redirect = function() {
                console.log('Redirecting due to session timeout');
                $('#status').removeClass('bg-info bg-warning').addClass('bg-danger').text('Session expired! Redirecting...');
                alert('Session timeout - would redirect to login page now');
                // In a real application, you would redirect to the login page:
                // window.location.href = "/login";
            };
            
            // Set up event handlers
            $(document).on('click', '#session-timeout-keepalive', function() {
                console.log('User clicked Stay Connected');
                
                // Hide the modal using multiple methods
                try {
                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                        var modalElement = document.getElementById('session-timeout-dialog');
                        var modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) {
                            modal.hide();
                        }
                    } else if ($.fn.modal) {
                        $('#session-timeout-dialog').modal('hide');
                    } else {
                        $('#session-timeout-dialog').hide();
                    }
                } catch (e) {
                    console.error('Error hiding modal:', e);
                    $('#session-timeout-dialog').hide();
                }
                
                resetTimers();
            });
            
            // Button to manually show warning
            $('#show-warning').click(function() {
                console.log('Manually showing warning');
                showWarning();
            });
            
            // Button to reset timers
            $('#reset-timers').click(function() {
                console.log('Resetting timers');
                resetTimers();
            });
            
            // Set up activity detection
            var activityEvents = 'click keypress scroll wheel mousewheel mousemove touchmove';
            $(document).on(activityEvents, function() {
                console.log('User activity detected, resetting timers');
                resetTimers();
            });
            
            // Initialize timers
            console.log('Initializing session timeout timers with warnAfter: ' + warnAfter + 'ms, redirAfter: ' + redirAfter + 'ms');
            resetTimers();
            console.log('Timers initialized');
        });
    </script>
</body>
</html>